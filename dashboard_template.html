<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Goalie Save Percentage Dashboard</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --bg-panel: rgba(15, 23, 42, 0.75);
        --bg-light: #f8fafc;
        --border: rgba(148, 163, 184, 0.35);
        --text: #0f172a;
        --text-muted: #475569;
        --accent: #2563eb;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(160deg, #020617, #0f172a 55%, #1e293b);
        color: white;
        min-height: 100vh;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        letter-spacing: -0.02em;
      }

      p.description {
        margin: 0;
        color: rgba(255, 255, 255, 0.75);
        max-width: 820px;
        line-height: 1.6;
      }

      .panel {
        background: var(--bg-panel);
        border: 1px solid rgba(255, 255, 255, 0.07);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(10px);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: flex-end;
      }

      label {
        display: block;
        margin-bottom: 0.35rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      select, input {
        width: 100%;
        padding: 0.65rem 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.06);
        color: white;
        font-size: 0.95rem;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      select:focus, input:focus {
        outline: none;
        border-color: rgba(37, 99, 235, 0.8);
        background: rgba(255, 255, 255, 0.1);
      }

      button {
        background: linear-gradient(120deg, #2563eb, #4f46e5);
        color: white;
        border: none;
        padding: 0.7rem 1.2rem;
        border-radius: 12px;
        font-weight: 700;
        letter-spacing: 0.01em;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
        box-shadow: 0 12px 35px rgba(37, 99, 235, 0.25);
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 40px rgba(37, 99, 235, 0.32);
      }

      button:active {
        transform: translateY(0);
        opacity: 0.9;
      }

      #savepct-chart {
        width: 100%;
        height: 580px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.85rem;
        margin-top: 1rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.07);
        border-radius: 12px;
        padding: 0.9rem 1rem;
      }

      .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
      }

      .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th, td {
        padding: 0.75rem 0.8rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      }

      th {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
      }

      td {
        color: rgba(255, 255, 255, 0.85);
      }

      tr:hover td {
        background: rgba(255, 255, 255, 0.03);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.2);
        color: white;
        border: 1px solid rgba(37, 99, 235, 0.45);
        font-size: 0.85rem;
      }

      .tab-bar {
        display: inline-flex;
        gap: 0.4rem;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.3rem;
        border-radius: 12px;
      }

      .tab-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.8);
        padding: 0.55rem 0.85rem;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        letter-spacing: 0.01em;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .tab-btn.active {
        background: rgba(37, 99, 235, 0.22);
        color: white;
        box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.35);
      }

      .tab-content {
        display: none;
        margin-top: 1rem;
      }

      .tab-content.active {
        display: block;
      }

      .table-note {
        margin: 0 0 0.75rem;
      }

      .muted {
        color: rgba(255, 255, 255, 0.65);
      }

      .dropped-list {
        margin-top: 0.4rem;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.6;
      }

      footer {
        color: rgba(255, 255, 255, 0.55);
        font-size: 0.9rem;
        text-align: center;
        padding-bottom: 2rem;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Goalie Save Percentage Dashboard</h1>
        <p class="description">Interactive view of goalie cumulative save percentage across leagues. Use the dropdowns below to switch leagues, filter by team, and search goalies.</p>
      </header>

      <div class="panel">
        <div class="controls">
          <div>
            <label for="league-selector">League</label>
            <select id="league-selector"></select>
          </div>
          <div>
            <label for="team-filter">Team filter</label>
            <select id="team-filter">
              <option value="ALL">All teams</option>
              __TEAM_OPTIONS__
            </select>
          </div>
          <div>
            <label for="goalie-search">Search goalie</label>
            <input id="goalie-search" type="search" placeholder="Type a goalie name..." />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="reset-view">Reset view</button>
          </div>
        </div>

        <div id="savepct-chart"></div>

        <div class="stats-grid" id="league-stats"></div>
      </div>

      <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.6rem;">
          <div>
            <h2 style="margin: 0;">Goalie details</h2>
            <p class="muted" style="margin: 0.2rem 0 0;">Switch between the season summary and per-game view.</p>
          </div>
          <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <div class="tag" id="active-league-name"></div>
            <div class="tab-bar" role="tablist">
              <button class="tab-btn active" data-tab="summary-tab" type="button">Summary</button>
              <button class="tab-btn" data-tab="gamelog-tab" type="button">Game log</button>
            </div>
          </div>
        </div>

        <div id="summary-tab" class="tab-content active" role="tabpanel">
          <table>
            <thead>
              <tr>
                <th data-key="goalie" class="sortable summary-sort">Goalie</th>
                <th data-key="team" class="sortable summary-sort">Team</th>
                <th data-key="games_played" class="sortable summary-sort">Games</th>
                <th data-key="total_shots" class="sortable summary-sort">Shots</th>
                <th data-key="goals_against" class="sortable summary-sort">GA</th>
                <th data-key="avg_shots_per_game" class="sortable summary-sort">Avg shots</th>
                <th data-key="final_save_pct" class="sortable summary-sort">Save %</th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody>
          </table>
          <div class="dropped-list" id="dropped-goalies"></div>
        </div>

        <div id="gamelog-tab" class="tab-content" role="tabpanel">
          <p class="muted table-note">Game-by-game goalie appearances with shots, saves and goals against.</p>
          <table id="gamelog-table">
            <thead>
              <tr>
                <th data-key="date_value" class="sortable gamelog-sort">Date</th>
                <th data-key="goalie" class="sortable gamelog-sort">Goalie</th>
                <th data-key="team" class="sortable gamelog-sort">Team</th>
                <th data-key="opponent" class="sortable gamelog-sort">Opponent</th>
                <th>Link</th>
                <th data-key="shots_against" class="sortable gamelog-sort">Shots</th>
                <th data-key="goals_against" class="sortable gamelog-sort">GA</th>
                <th data-key="saves" class="sortable gamelog-sort">Saves</th>
                <th data-key="save_pct" class="sortable gamelog-sort">Save %</th>
              </tr>
            </thead>
            <tbody id="gamelog-body"></tbody>
          </table>
        </div>
      </div>

      <footer>
        Built with <span aria-hidden="true">üèë</span> using statistik.innebandy.se data. Cumulative save percentage is calculated from saves/shots over time; goalies with zero shots are excluded from the chart but listed above.
      </footer>
    </div>

      <script>
        const leagues = __LEAGUES_JSON__;

      function populateLeagueSelector() {
        const selector = document.getElementById('league-selector');
        selector.innerHTML = '';
        leagues.forEach((league) => {
          const option = document.createElement('option');
          option.value = league.key;
          option.textContent = league.name;
          selector.appendChild(option);
        });
      }

      function formatNumber(n) {
        return new Intl.NumberFormat('sv-SE').format(n);
      }

      function formatDateLabel(raw) {
        if (!raw) return '‚Äì';
        const date = new Date(raw);
        if (!Number.isFinite(date.getTime())) {
          const text = String(raw);
          return text.includes('T') ? text.split('T')[0] : text;
        }
        return new Intl.DateTimeFormat('sv-SE', { year: 'numeric', month: 'short', day: 'numeric' }).format(date);
      }

      function formatTimeOnIce(seconds) {
        if (seconds === null || seconds === undefined) return '‚Äì';
        const total = Number(seconds);
        if (!Number.isFinite(total) || total < 0) return '‚Äì';
        const mins = Math.floor(total / 60);
        const secs = Math.round(total % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }

      function formatSavePct(value) {
        return value === null || value === undefined || Number.isNaN(value) ? '‚Äì' : `${(value * 100).toFixed(1)}%`;
      }

      function renderStats(league) {
        const stats = league.stats;
        const container = document.getElementById('league-stats');
        container.innerHTML = '';
        const entries = [
          ['Goalies', stats.total_goalies],
          ['Teams', stats.total_teams],
          ['Date range', stats.date_range],
          ['Zero-shot goalies', stats.zero_shot_goalies],
        ];
        entries.forEach(([label, value]) => {
          const card = document.createElement('div');
          card.className = 'stat-card';
          card.innerHTML = `<div class="stat-label">${label}</div><div class="stat-value">${value}</div>`;
          container.appendChild(card);
        });
      }

      function renderTable(records) {
        const tbody = document.getElementById('summary-body');
        tbody.innerHTML = '';
        records.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.goalie}</td>
            <td>${row.team ?? ''}</td>
            <td>${row.games_played}</td>
            <td>${formatNumber(row.total_shots)}</td>
            <td>${formatNumber(row.goals_against)}</td>
            <td>${row.avg_shots_per_game.toFixed(1)}</td>
            <td>${row.save_pct_display}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderDropped(list) {
        const target = document.getElementById('dropped-goalies');
        if (!list || list.length === 0) {
          target.textContent = '';
          return;
        }
        target.innerHTML = `<div class="muted">Filtered out (0 shots): ${list.join(', ')}</div>`;
      }

      function renderGameLog(records) {
        const tbody = document.getElementById('gamelog-body');
        const numberText = (value) =>
          value === null || value === undefined || Number.isNaN(value) ? '‚Äì' : formatNumber(value);
        tbody.innerHTML = '';
        records.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.date_display ?? formatDateLabel(row.date)}</td>
            <td>${row.goalie ?? ''}</td>
            <td>${row.team ?? ''}</td>
            <td>${row.opponent ?? ''}</td>
            <td>${row.url ? `<a href="${row.url}" target="_blank" rel="noopener">View</a>` : '‚Äì'}</td>
            <td>${numberText(row.shots_against)}</td>
            <td>${numberText(row.goals_against)}</td>
            <td>${numberText(row.saves)}</td>
            <td>${row.save_pct_display ?? formatSavePct(row.save_pct)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function applyGameFilters(records) {
        const team = document.getElementById('team-filter').value;
        const query = document.getElementById('goalie-search').value.trim().toLowerCase();
        return records.filter((row) => {
          const matchesTeam = team === 'ALL' || row.team === team;
          const matchesQuery = !query || row.goalie?.toLowerCase().includes(query);
          return matchesTeam && matchesQuery;
        });
      }

      function deriveGameRecords(league) {
        if (league.game_records && league.game_records.length) {
          return league.game_records;
        }

        const rows = [];
        (league.figure?.data ?? []).forEach((trace) => {
          let prevSaves = 0;
          let prevShots = 0;
          const custom = trace.customdata || [];
          const dates = trace.x || [];
          custom.forEach((item, idx) => {
            const [team, gameId, cumulativeSaves, cumulativeShots] = item || [];
            const nextCumulativeSaves = Number.isFinite(Number(cumulativeSaves)) ? Number(cumulativeSaves) : null;
            const nextCumulativeShots = Number.isFinite(Number(cumulativeShots)) ? Number(cumulativeShots) : null;
            const saves = nextCumulativeSaves === null ? null : nextCumulativeSaves - prevSaves;
            const shots = nextCumulativeShots === null ? null : nextCumulativeShots - prevShots;
            const goalsAgainst = shots === null || saves === null ? null : shots - saves;
            if (nextCumulativeSaves !== null) prevSaves = nextCumulativeSaves;
            if (nextCumulativeShots !== null) prevShots = nextCumulativeShots;
            const rawDate = dates[idx] ?? null;
            const dateValue = Date.parse(rawDate);
            const savePct = shots > 0 && saves !== null ? saves / shots : null;
            rows.push({
              game_id: gameId,
              goalie: trace.name,
              team: team ?? '',
              opponent: null,
              date: rawDate,
              date_value: Number.isFinite(dateValue) ? dateValue : null,
              saves: saves,
              shots_against: shots,
              goals_against: goalsAgainst,
              save_pct: savePct,
              save_pct_display: formatSavePct(savePct),
              time_on_ice_seconds: null,
              time_on_ice_display: '‚Äì',
            });
          });
        });
        return rows;
      }

      function prepareGameRecords(league) {
        const records = deriveGameRecords(league);
        return records.map((row) => {
          const dateValue = row.date_value ?? Date.parse(row.date);
          const opponent =
            row.opponent ??
            (row.team && row.home_team && row.away_team
              ? row.team === row.home_team
                ? row.away_team
                : row.home_team
              : row.away_team ?? row.home_team ?? '');
          const shots = Number.isFinite(Number(row.shots_against)) ? Number(row.shots_against) : null;
          const saves = Number.isFinite(Number(row.saves)) ? Number(row.saves) : null;
          const savePct = row.save_pct ?? (shots > 0 && saves !== null ? saves / shots : null);
          return {
            ...row,
            opponent,
            shots_against: shots,
            saves,
            save_pct: savePct,
            save_pct_display: row.save_pct_display ?? formatSavePct(savePct),
            date_value: Number.isFinite(dateValue) ? dateValue : null,
            date_display: row.date_display ?? formatDateLabel(row.date),
            time_on_ice_display: row.time_on_ice_display ?? formatTimeOnIce(row.time_on_ice_seconds),
          };
        });
      }

      function activateTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.tab === tabId);
        });
        document.querySelectorAll('.tab-content').forEach((panel) => {
          panel.classList.toggle('active', panel.id === tabId);
        });
      }

      function sortBy(key, ascending) {
        return (a, b) => {
          const av = a[key];
          const bv = b[key];
          if (av === bv) return 0;
          if (av === null || av === undefined) return 1;
          if (bv === null || bv === undefined) return -1;
          const comp = av > bv ? 1 : -1;
          return ascending ? comp : -comp;
        };
      }

      function applyFilters(records) {
        const team = document.getElementById('team-filter').value;
        const query = document.getElementById('goalie-search').value.trim().toLowerCase();
        return records.filter((row) => {
          const matchesTeam = team === 'ALL' || row.team === team;
          const matchesQuery = !query || row.goalie.toLowerCase().includes(query);
          return matchesTeam && matchesQuery;
        });
      }

      let summaryData = [];
      let gameLogData = [];
      let sortState = { key: 'team', ascending: true };
      let gameSortState = { key: 'date_value', ascending: false };
      let traceGoalies = [];

      function restyleChart() {
        if (traceGoalies.length === 0) return;
        const team = document.getElementById('team-filter').value;
        const query = document.getElementById('goalie-search').value.trim().toLowerCase();
        const visibility = traceGoalies.map((goalie) => {
          const matchesTeam = team === 'ALL' || (goalie in currentLeague.goalie_to_team && currentLeague.goalie_to_team[goalie] === team);
          const matchesQuery = !query || goalie.toLowerCase().includes(query);
          return matchesTeam && matchesQuery;
        });
        Plotly.restyle('savepct-chart', { visible: visibility }, Array.from(traceGoalies.keys()));
      }

      function loadLeague(key) {
        currentLeague = leagues.find((league) => league.key === key) ?? leagues[0];
        summaryData = currentLeague.summary_records;
        gameLogData = prepareGameRecords(currentLeague);
        traceGoalies = currentLeague.trace_goalies;
        document.getElementById('active-league-name').textContent = currentLeague.name;

        const teamSelect = document.getElementById('team-filter');
        teamSelect.innerHTML = '<option value="ALL">All teams</option>' + currentLeague.team_options.map((team) => `<option value="${team}">${team}</option>`).join('');

        const sorted = summaryData.sort(sortBy(sortState.key, sortState.ascending));
        renderTable(applyFilters(sorted));
        const sortedGames = applyGameFilters(gameLogData).sort(sortBy(gameSortState.key, gameSortState.ascending));
        renderGameLog(sortedGames);
        renderDropped(currentLeague.dropped_goalies);
        renderStats(currentLeague);

        Plotly.newPlot('savepct-chart', currentLeague.figure.data, currentLeague.figure.layout, { responsive: true });
        restyleChart();
        activateTab(document.querySelector('.tab-btn.active')?.dataset.tab ?? 'summary-tab');
      }

      let currentLeague = null;

      window.addEventListener('DOMContentLoaded', () => {
        populateLeagueSelector();
        loadLeague(leagues[0].key);

        document.getElementById('league-selector').addEventListener('change', (event) => {
          loadLeague(event.target.value);
        });

        document.getElementById('team-filter').addEventListener('change', () => {
          const filtered = applyFilters(summaryData).sort(sortBy(sortState.key, sortState.ascending));
          renderTable(filtered);
          const gameFiltered = applyGameFilters(gameLogData).sort(sortBy(gameSortState.key, gameSortState.ascending));
          renderGameLog(gameFiltered);
          restyleChart();
        });

        document.getElementById('goalie-search').addEventListener('input', () => {
          const filtered = applyFilters(summaryData).sort(sortBy(sortState.key, sortState.ascending));
          renderTable(filtered);
          const gameFiltered = applyGameFilters(gameLogData).sort(sortBy(gameSortState.key, gameSortState.ascending));
          renderGameLog(gameFiltered);
          restyleChart();
        });

        document.getElementById('reset-view').addEventListener('click', () => {
          sortState = { key: 'team', ascending: true };
          gameSortState = { key: 'date_value', ascending: false };
          document.getElementById('team-filter').value = 'ALL';
          document.getElementById('goalie-search').value = '';
          renderTable(summaryData.sort(sortBy(sortState.key, sortState.ascending)));
          renderGameLog(applyGameFilters(gameLogData).sort(sortBy(gameSortState.key, gameSortState.ascending)));
          traceGoalies.forEach((goalie, index) => {
            Plotly.restyle('savepct-chart', { visible: true }, [index]);
          });
          activateTab('summary-tab');
        });

        document.querySelectorAll('.summary-sort').forEach((th) => {
          th.addEventListener('click', () => {
            const key = th.dataset.key;
            if (sortState.key === key) {
              sortState.ascending = !sortState.ascending;
            } else {
              sortState = { key, ascending: true };
            }
            const filtered = applyFilters(summaryData).sort(sortBy(sortState.key, sortState.ascending));
            renderTable(filtered);
          });
        });

        document.querySelectorAll('.gamelog-sort').forEach((th) => {
          th.addEventListener('click', () => {
            const key = th.dataset.key;
            if (gameSortState.key === key) {
              gameSortState.ascending = !gameSortState.ascending;
            } else {
              gameSortState = { key, ascending: key === 'date_value' ? false : true };
            }
            const filtered = applyGameFilters(gameLogData).sort(sortBy(gameSortState.key, gameSortState.ascending));
            renderGameLog(filtered);
          });
        });

        document.querySelectorAll('.tab-btn').forEach((btn) => {
          btn.addEventListener('click', () => activateTab(btn.dataset.tab));
        });

        Plotly.newPlot('savepct-chart', leagues[0].figure.data, leagues[0].figure.layout, { responsive: true });
        Plotly.d3.select('#savepct-chart').on('plotly_doubleclick', () => {
          document.getElementById('reset-view').click();
        });
      });
      </script>
    </body>
</html>
