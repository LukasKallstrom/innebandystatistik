<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Goalie Save Percentage Dashboard</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --bg-panel: rgba(15, 23, 42, 0.75);
        --bg-light: #f8fafc;
        --border: rgba(148, 163, 184, 0.35);
        --text: #0f172a;
        --text-muted: #475569;
        --accent: #2563eb;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(160deg, #020617, #0f172a 55%, #1e293b);
        color: white;
        min-height: 100vh;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        letter-spacing: -0.02em;
      }

      p.description {
        margin: 0;
        color: rgba(255, 255, 255, 0.75);
        max-width: 820px;
        line-height: 1.6;
      }

      .panel {
        background: var(--bg-panel);
        border: 1px solid rgba(255, 255, 255, 0.07);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(10px);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: flex-end;
      }

      label {
        display: block;
        margin-bottom: 0.35rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      select, input {
        width: 100%;
        padding: 0.65rem 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.06);
        color: white;
        font-size: 0.95rem;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      select:focus, input:focus {
        outline: none;
        border-color: rgba(37, 99, 235, 0.8);
        background: rgba(255, 255, 255, 0.1);
      }

      button {
        background: linear-gradient(120deg, #2563eb, #4f46e5);
        color: white;
        border: none;
        padding: 0.7rem 1.2rem;
        border-radius: 12px;
        font-weight: 700;
        letter-spacing: 0.01em;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
        box-shadow: 0 12px 35px rgba(37, 99, 235, 0.25);
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 40px rgba(37, 99, 235, 0.32);
      }

      button:active {
        transform: translateY(0);
        opacity: 0.9;
      }

      #savepct-chart {
        width: 100%;
        height: 580px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.85rem;
        margin-top: 1rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.07);
        border-radius: 12px;
        padding: 0.9rem 1rem;
      }

      .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
      }

      .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th, td {
        padding: 0.75rem 0.8rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      }

      th {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
      }

      td {
        color: rgba(255, 255, 255, 0.85);
      }

      tr:hover td {
        background: rgba(255, 255, 255, 0.03);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.2);
        color: white;
        border: 1px solid rgba(37, 99, 235, 0.45);
        font-size: 0.85rem;
      }

      .muted {
        color: rgba(255, 255, 255, 0.65);
      }

      .dropped-list {
        margin-top: 0.4rem;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.6;
      }

      footer {
        color: rgba(255, 255, 255, 0.55);
        font-size: 0.9rem;
        text-align: center;
        padding-bottom: 2rem;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Goalie Save Percentage Dashboard</h1>
        <p class="description">Interactive view of goalie cumulative save percentage across leagues. Use the dropdowns below to switch leagues, filter by team, and search goalies.</p>
      </header>

      <div class="panel">
        <div class="controls">
          <div>
            <label for="league-selector">League</label>
            <select id="league-selector"></select>
          </div>
          <div>
            <label for="team-filter">Team filter</label>
            <select id="team-filter">
              <option value="ALL">All teams</option>
              __TEAM_OPTIONS__
            </select>
          </div>
          <div>
            <label for="goalie-search">Search goalie</label>
            <input id="goalie-search" type="search" placeholder="Type a goalie name..." />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="reset-view">Reset view</button>
          </div>
        </div>

        <div id="savepct-chart"></div>

        <div class="stats-grid" id="league-stats"></div>
      </div>

      <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
          <h2 style="margin: 0;">Goalie summary</h2>
          <div class="tag" id="active-league-name"></div>
        </div>
        <table>
          <thead>
            <tr>
              <th data-key="goalie" class="sortable">Goalie</th>
              <th data-key="team" class="sortable">Team</th>
              <th data-key="games_played" class="sortable">Games</th>
              <th data-key="total_shots" class="sortable">Shots</th>
              <th data-key="goals_against" class="sortable">GA</th>
              <th data-key="avg_shots_per_game" class="sortable">Avg shots</th>
              <th data-key="final_save_pct" class="sortable">Save %</th>
            </tr>
          </thead>
          <tbody id="summary-body"></tbody>
        </table>
        <div class="dropped-list" id="dropped-goalies"></div>
      </div>

      <footer>
        Built with <span aria-hidden="true">üèë</span> using statistik.innebandy.se data. Cumulative save percentage is calculated from saves/shots over time; goalies with zero shots are excluded from the chart but listed above.
      </footer>
    </div>

      <script>
        const leagues = __LEAGUES_JSON__;

      function populateLeagueSelector() {
        const selector = document.getElementById('league-selector');
        selector.innerHTML = '';
        leagues.forEach((league) => {
          const option = document.createElement('option');
          option.value = league.key;
          option.textContent = league.name;
          selector.appendChild(option);
        });
      }

      function formatNumber(n) {
        return new Intl.NumberFormat('sv-SE').format(n);
      }

      function renderStats(league) {
        const stats = league.stats;
        const container = document.getElementById('league-stats');
        container.innerHTML = '';
        const entries = [
          ['Goalies', stats.total_goalies],
          ['Teams', stats.total_teams],
          ['Date range', stats.date_range],
          ['Zero-shot goalies', stats.zero_shot_goalies],
        ];
        entries.forEach(([label, value]) => {
          const card = document.createElement('div');
          card.className = 'stat-card';
          card.innerHTML = `<div class="stat-label">${label}</div><div class="stat-value">${value}</div>`;
          container.appendChild(card);
        });
      }

      function renderTable(records) {
        const tbody = document.getElementById('summary-body');
        tbody.innerHTML = '';
        records.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.goalie}</td>
            <td>${row.team ?? ''}</td>
            <td>${row.games_played}</td>
            <td>${formatNumber(row.total_shots)}</td>
            <td>${formatNumber(row.goals_against)}</td>
            <td>${row.avg_shots_per_game.toFixed(1)}</td>
            <td>${row.save_pct_display}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderDropped(list) {
        const target = document.getElementById('dropped-goalies');
        if (!list || list.length === 0) {
          target.textContent = '';
          return;
        }
        target.innerHTML = `<div class="muted">Filtered out (0 shots): ${list.join(', ')}</div>`;
      }

      function sortBy(key, ascending) {
        return (a, b) => {
          const av = a[key];
          const bv = b[key];
          if (av === bv) return 0;
          if (av === null || av === undefined) return 1;
          if (bv === null || bv === undefined) return -1;
          const comp = av > bv ? 1 : -1;
          return ascending ? comp : -comp;
        };
      }

      function applyFilters(records) {
        const team = document.getElementById('team-filter').value;
        const query = document.getElementById('goalie-search').value.trim().toLowerCase();
        return records.filter((row) => {
          const matchesTeam = team === 'ALL' || row.team === team;
          const matchesQuery = !query || row.goalie.toLowerCase().includes(query);
          return matchesTeam && matchesQuery;
        });
      }

      let summaryData = [];
      let sortState = { key: 'team', ascending: true };
      let traceGoalies = [];

      function restyleChart() {
        if (traceGoalies.length === 0) return;
        const team = document.getElementById('team-filter').value;
        const query = document.getElementById('goalie-search').value.trim().toLowerCase();
        const visibility = traceGoalies.map((goalie) => {
          const matchesTeam = team === 'ALL' || (goalie in currentLeague.goalie_to_team && currentLeague.goalie_to_team[goalie] === team);
          const matchesQuery = !query || goalie.toLowerCase().includes(query);
          return matchesTeam && matchesQuery;
        });
        Plotly.restyle('savepct-chart', { visible: visibility }, Array.from(traceGoalies.keys()));
      }

      function loadLeague(key) {
        currentLeague = leagues.find((league) => league.key === key) ?? leagues[0];
        summaryData = currentLeague.summary_records;
        traceGoalies = currentLeague.trace_goalies;
        document.getElementById('active-league-name').textContent = currentLeague.name;

        const teamSelect = document.getElementById('team-filter');
        teamSelect.innerHTML = '<option value="ALL">All teams</option>' + currentLeague.team_options.map((team) => `<option value="${team}">${team}</option>`).join('');

        const sorted = summaryData.sort(sortBy(sortState.key, sortState.ascending));
        renderTable(applyFilters(sorted));
        renderDropped(currentLeague.dropped_goalies);
        renderStats(currentLeague);

        Plotly.newPlot('savepct-chart', currentLeague.figure.data, currentLeague.figure.layout, { responsive: true });
        restyleChart();
      }

      let currentLeague = null;

      window.addEventListener('DOMContentLoaded', () => {
        populateLeagueSelector();
        loadLeague(leagues[0].key);

        document.getElementById('league-selector').addEventListener('change', (event) => {
          loadLeague(event.target.value);
        });

        document.getElementById('team-filter').addEventListener('change', () => {
          const filtered = applyFilters(summaryData).sort(sortBy(sortState.key, sortState.ascending));
          renderTable(filtered);
          restyleChart();
        });

        document.getElementById('goalie-search').addEventListener('input', () => {
          const filtered = applyFilters(summaryData).sort(sortBy(sortState.key, sortState.ascending));
          renderTable(filtered);
          restyleChart();
        });

        document.getElementById('reset-view').addEventListener('click', () => {
          sortState = { key: 'team', ascending: true };
          document.getElementById('team-filter').value = 'ALL';
          document.getElementById('goalie-search').value = '';
          renderTable(summaryData.sort(sortBy(sortState.key, sortState.ascending)));
          traceGoalies.forEach((goalie, index) => {
            Plotly.restyle('savepct-chart', { visible: true }, [index]);
          });
        });

        document.querySelectorAll('th.sortable').forEach((th) => {
          th.addEventListener('click', () => {
            const key = th.dataset.key;
            if (sortState.key === key) {
              sortState.ascending = !sortState.ascending;
            } else {
              sortState = { key, ascending: true };
            }
            const filtered = applyFilters(summaryData).sort(sortBy(sortState.key, sortState.ascending));
            renderTable(filtered);
          });
        });

        Plotly.newPlot('savepct-chart', leagues[0].figure.data, leagues[0].figure.layout, { responsive: true });
        Plotly.d3.select('#savepct-chart').on('plotly_doubleclick', () => {
          document.getElementById('reset-view').click();
        });
      });
      </script>
    </body>
</html>
